rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    // Role is stored in Firestore (users/{uid}.role).
    // NOTE: later we should move roles to custom claims for stronger security.
    function myUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function myRole() {
      return isSignedIn() && (myUserDoc().data.role is string) ? myUserDoc().data.role : "OPERADOR";
    }

    // Approval gate:
    // A user must have users/{uid}.approved == true to use the app (read/write data).
    function isApproved() {
      return isSignedIn() && (myUserDoc().data.approved == true);
    }

    function isAdmin() {
      return isSignedIn() && myRole() == "ADMIN";
    }

    function isSupervisorOrAdmin() {
      return isSignedIn() && (myRole() == "SUPERVISOR" || myRole() == "ADMIN");
    }

    // USERS
    // - Self-signup creates users/{uid} with role OPERADOR
    // - User can update their own profile BUT cannot change role
    // - Admin can read/update any user (including role changes)
    match /users/{uid} {
      // Self-signup: allow the user to create their own profile doc.
      // New users must start as OPERADOR and NOT approved.
      allow create: if isSignedIn()
                    && request.auth.uid == uid
                    && request.resource.data.role == "OPERADOR"
                    && request.resource.data.approved == false;

      // Users can read their own doc (to see approval status).
      // Admins can read any user doc.
      allow read: if isSignedIn()
                  && (request.auth.uid == uid || isAdmin());

      // Admins can update any user doc (including role/approved).
      // Users can update their own doc but cannot change role or approved.
      allow update: if isSignedIn()
                    && (
                      isAdmin()
                      || (
                        request.auth.uid == uid
                        // prevent privilege escalation:
                        && request.resource.data.role == resource.data.role
                        // prevent self-approval:
                        && request.resource.data.approved == resource.data.approved
                      )
                    );

      allow delete: if false;
    }

    // CLIENTS
    // Dropdown options for Produtivo -> Cliente.
    // - Any signed-in user can read (to populate the dropdown)
    // - Only Admin can create/update
    // - Delete disabled; use active=false
    match /clients/{clientId} {
      // Any approved user can read clients (dropdown).
      allow read: if isApproved();

      // Only approved admins can create/update.
      allow create, update: if isApproved() && isAdmin();

      allow delete: if false;
    }

    // EVENTS
    // Each operation record is stored as a document in /events.
    // - Operator: can create/read/update only their own events
    // - Supervisor/Admin: can read/update all events
    // - Delete disabled (use soft-delete later)
    match /events/{eventId} {
      allow create: if isApproved()
                    && request.resource.data.createdBy == request.auth.uid;

      allow read: if isApproved()
                  && (
                    isSupervisorOrAdmin()
                    || resource.data.createdBy == request.auth.uid
                  );

      allow update: if isApproved()
                    && (
                      isSupervisorOrAdmin()
                      || resource.data.createdBy == request.auth.uid
                    );

      allow delete: if false;
    }

    // Default deny (explicit allow only)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}