rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    // Role is stored in Firestore (users/{uid}.role).
    // NOTE: later we should move roles to custom claims for stronger security.
    function myUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function myRole() {
      return isSignedIn() && (myUserDoc().data.role is string) ? myUserDoc().data.role : "OPERADOR";
    }

    // Approval gate:
    // A user must have users/{uid}.approved == true to use the app (read/write data).
    function isApproved() {
      return isSignedIn() && (myUserDoc().data.approved == true);
    }

    function isAdmin() {
      return isSignedIn() && myRole() == "ADMIN";
    }

    function isSupervisorOrAdmin() {
      return isSignedIn() && (myRole() == "SUPERVISOR" || myRole() == "ADMIN");
    }

    // ===== Events schema validation (create only) =====

    function isValidPump(p) {
      return (p is int) && (p == 1 || p == 2);
    }

    function isValidShift(s) {
      return (s is string) && (s in ["MANHA", "NOITE"]);
    }

    function isValidCategory(c) {
      return (c is string) && (c in ["Produtivo", "Aguardando laboratório", "Sem caminhão", "Sem container", "Manutenção", "Outros"]);
    }

    function isValidShiftDate(d) {
      return (d is string) && d.matches("^\\d{4}-\\d{2}-\\d{2}$");
    }

    function isNonEmptyString(s) {
      return (s is string) && s.size() > 0;
    }

    function isValidTimestamp(t) {
      return t is timestamp;
    }

    function isTimeOrderValid(startAt, endAt) {
      return isValidTimestamp(startAt) && isValidTimestamp(endAt) && (startAt < endAt);
    }

    function categoryRequiresNotes(category) {
      return category in ["Outros", "Sem caminhão", "Manutenção", "Aguardando laboratório", "Sem container"];
    }

    function categoryRequiresProdutivoFields(category) {
      return category == "Produtivo";
    }

    function clientExistsAndIsActive(clientId) {
      return isNonEmptyString(clientId)
        && exists(/databases/$(database)/documents/clients/$(clientId))
        && get(/databases/$(database)/documents/clients/$(clientId)).data.active == true;
    }

    function hasOnlyAllowedEventKeys(data) {
      // Keep this list aligned with the frontend payload in [`save()`](transbordo-app/src/App.tsx:954)
      return data.keys().hasOnly([
        "createdBy",
        "createdByEmail",
        "createdAt",
        "updatedAt",
        "pump",
        "shiftDate",
        "shift",
        "category",
        "startAt",
        "endAt",
        "clientId",
        "clientName",
        "truckPlate",
        "containerId",
        "notes"
      ]);
    }

    function isValidEventCreate(data) {
      return (data.createdBy == request.auth.uid)
        && isValidPump(data.pump)
        && isValidShiftDate(data.shiftDate)
        && isValidShift(data.shift)
        && isValidCategory(data.category)
        && isTimeOrderValid(data.startAt, data.endAt)

        // Client required for all categories
        && clientExistsAndIsActive(data.clientId)

        // Optional fields types
        && (!("createdByEmail" in data) || (data.createdByEmail is string))
        && (!("clientName" in data) || (data.clientName is string))

        // Notes required depending on category
        && (!categoryRequiresNotes(data.category) || (("notes" in data) && isNonEmptyString(data.notes)))

        // Produtivo requires truckPlate + containerId
        && (!categoryRequiresProdutivoFields(data.category)
          || (("truckPlate" in data) && isNonEmptyString(data.truckPlate) && ("containerId" in data) && isNonEmptyString(data.containerId)))

        // Optional keys whitelist (prevents unexpected data injection)
        && hasOnlyAllowedEventKeys(data);
    }

    // USERS
    // - Self-signup creates users/{uid} with role OPERADOR
    // - User can update their own profile BUT cannot change role
    // - Admin can read/update any user (including role changes)
    match /users/{uid} {
      // Self-signup: allow the user to create their own profile doc.
      // New users must start as OPERADOR and NOT approved.
      allow create: if isSignedIn()
                    && request.auth.uid == uid
                    && request.resource.data.role == "OPERADOR"
                    && request.resource.data.approved == false;

      // Users can read their own doc (to see approval status).
      // Admins can read any user doc.
      allow read: if isSignedIn()
                  && (request.auth.uid == uid || isAdmin());

      // Admins can update any user doc (including role/approved).
      // Users can update their own doc but cannot change role or approved.
      allow update: if isSignedIn()
                    && (
                      isAdmin()
                      || (
                        request.auth.uid == uid
                        // prevent privilege escalation:
                        && request.resource.data.role == resource.data.role
                        // prevent self-approval:
                        && request.resource.data.approved == resource.data.approved
                      )
                    );

      allow delete: if false;
    }

    // CLIENTS
    // Dropdown options for Produtivo -> Cliente.
    // - Any signed-in user can read (to populate the dropdown)
    // - Only Admin can create/update
    // - Delete disabled; use active=false
    match /clients/{clientId} {
      // Any approved user can read clients (dropdown).
      allow read: if isApproved();

      // Only approved admins can create/update.
      allow create, update: if isApproved() && isAdmin();

      allow delete: if false;
    }

    // EVENTS
    // Each operation record is stored as a document in /events.
    // - Operator: can create/read/update only their own events
    // - Supervisor/Admin: can read/update all events
    // - Delete disabled (use soft-delete later)
    match /events/{eventId} {
      allow create: if isApproved()
                    && isValidEventCreate(request.resource.data);

      allow read: if isApproved()
                  && (
                    isSupervisorOrAdmin()
                    || resource.data.createdBy == request.auth.uid
                  );

      // Updates are blocked for now because the app has no "edit event" UI yet.
      // This avoids privilege escalation / tampering with immutable fields.
      allow update: if false;

      allow delete: if false;
    }

    // Default deny (explicit allow only)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}